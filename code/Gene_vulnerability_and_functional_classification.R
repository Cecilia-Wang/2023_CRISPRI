# this section of code is highly customized for our own study

# this will prep the environment and load exact test results
source("~/Downloads/2023_CRISPRI-main/code/M1_enviro_prep_load_data.R")


######### customize to fit your own dataset. The two most important grouping factors we used here are sample times and ATc concentrations, please customise where necessary

# convert the timepoint data to factor format 
ex_res_all_multirun$day<-factor(ex_res_all_multirun$day,levels = c("d5","d10","d14"))

# Calculate the total number of guides included in the downstream analyses
ex_res_guide_total<- ex_res_all_multirun %>% 
  # only keeps data under atc-3, 30 and 300.
  subset( ., .$atc.conc%in%c("Atc-3","Atc-30" ,"Atc-300")) %>%
  group_by(strain,day,exp.id) %>% summarise(NO_tg=length(unique(guide.id)),No_gene=length(unique(target.gene)))

# Identify depleted guides across timepoints and ATc concentrations

# We used 0.01 adjusted p.value cutoff, feel free to change to less stringent (e.g. 0.05)
ex_res_subset<- ex_res_all_multirun %>% 
  subset( ., .$atc.conc%in%c("Atc-3","Atc-30" ,"Atc-300")) %>% 
  subset(.,.$target.gene != "NEG") %>% 
  mutate(diffexpressed = "Not_depleted") %>% 
  mutate(diffexpressed = ifelse(.$logFC <=-1 & .$p.adj < 0.01, "Depleted", diffexpressed))

# calculate total number of guides per gene per condition
total_sgRNA_our_ex_res<-ex_res_subset %>%
  dplyr::group_by(strain,day,atc.conc,target.gene,exp.id) %>%
  dplyr::summarise(guidePG=length(unique(guide.id)))

ex_res_subset$guidePG<-total_sgRNA_our_ex_res$guidePG[match(paste0(ex_res_subset$target.gene,ex_res_subset$atc.conc,ex_res_subset$strain,ex_res_subset$day,ex_res_subset$exp.id),paste0(total_sgRNA_our_ex_res$target.gene,total_sgRNA_our_ex_res$atc.conc,total_sgRNA_our_ex_res$strain,total_sgRNA_our_ex_res$day,total_sgRNA_our_ex_res$exp.id))]

## define Depleted genes (at least 2 depleted guides per gene)
ess_genes<-ex_res_subset %>%
  subset(diffexpressed=="Depleted"&target.gene!="NEG") %>%
  group_by(strain,target.gene,day,atc.conc,exp.id,guidePG) %>% 
  summarise(SgRNA_n=length(unique(guide.id))) %>%
  subset(SgRNA_n>=2) %>% 
  mutate(Essentiality="Essential", groupID=paste0(target.gene,strain,day,atc.conc,exp.id))


########### optional step ########### 
# Due to the experimental design, the number of depleted guides is ATc-dose depended and will increase over time. Therefore, we set the day 14 ATc-300 as the final results to determine the essential genes. Therefore, this is an optional step.
ess_genes_final<-ess_genes %>% 
  subset(day=="d14" & atc.conc=="Atc-300") 
########### ########### ########### 


## assign subclasses and classes per target.gene

Total_gene_per_subclass<-ex_res_all_multirun  %>% subset(target.gene!="NEG")%>% select(c(target.gene)) %>% unique()

Total_gene_per_subclass$Class<-PATRIC_functions$Class[match(Total_gene_per_subclass$target.gene,PATRIC_functions$target.gene)]
Total_gene_per_subclass$Subclass<-PATRIC_functions$Subclass[match(Total_gene_per_subclass$target.gene,PATRIC_functions$target.gene)]
Total_gene_per_subclass[is.na(Total_gene_per_subclass)]<-"Unknown"

## calculate the total number of target genes per subclass and class
Total_gene_per_subclass1<-Total_gene_per_subclass %>% group_by(Class,Subclass) %>% summarise(total_tg=length(unique(target.gene)))
Total_gene_per_class1<-Total_gene_per_subclass %>% group_by(Class) %>% summarise(gene_total_class=length(unique(target.gene)))
